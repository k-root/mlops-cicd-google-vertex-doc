steps:
- name: 'gcr.io/cloud-builders/git'
  args: ['remote', 'set-url', 'origin',
         'git@github.com:$$USERNAME/mlops-cicd-google-vertex-doc.git']
  secretEnv: ['USERNAME']
  id: 'Set git env'
# - name: 'gcr.io/cloud-builders/git'
#   args: ['config', '--global', 'user.name',
#          '$$USERNAME']
#   secretEnv: ['USERNAME']
#   id: 'Set git env username'
- name: 'gcr.io/cloud-builders/git'
  args: ['config', '--global', 'user.password',
         '$$PASSWORD']
  secretEnv: ['PASSWORD']
  id: 'Set git env password'
- name: 'gcr.io/cloud-builders/git'
  args: ['clone', '--single-branch', '--branch',
         'main','https://github.com/k-root/mlops-cicd-google-vertex-doc.git',
         '--depth', '1',
         '--verbose']
  secretEnv: ['USERNAME', 'PASSWORD']
  id: 'Clone Repository'
  
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '*.py', '*.yaml', 'gs://springml-notebook-testing-mlops-artifacts/pipeline_root/chicago-taxi-pipe/modules']
  dir: 'mlops-cicd-google-vertex-doc'
  id: 'Copy Modules'
  waitFor: ['Clone Repository']


- name: 'gcr.io/springml-notebook-testing/mlops-vertex-kfp:latest'
  # entrypoint: 'python'
  args: ['python', 'build_and_run_pipeline.py' ]
  dir: 'mlops-cicd-google-vertex-doc'
  id: 'Compile and Run Pipeline'
  waitFor: ['Copy Modules']

availableSecrets:
  secretManager:
  - versionName: projects/springml-notebook-testing/secrets/git_passkey/versions/latest
    env: 'PASSWORD'
  - versionName: projects/springml-notebook-testing/secrets/git_username/versions/latest
    env: 'USERNAME'
options:
  logging: CLOUD_LOGGING_ONLY